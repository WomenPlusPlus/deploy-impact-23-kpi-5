name: Flask Web App to Azure App

env:
  AZURE_WEBAPP_NAME: kpi5Graphics
  RESOURCE_GROUP: Womenplusplus
  PYTHON_VERSION: '3.10.x'
  APP_LOCATION: 'src/FlaskGraphics'

on:
  push:
    branches: [ "main" ]
    paths: 'src/FlaskGraphics/**'

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 
      uses: actions/setup-python@v3
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    #- name: Create and start virtual environment
      #run: |
         # python -m venv venv
         # source venv/bin/activate
      #working-directory: ${{ env.APP_LOCATION }}

    - name: Install dependencies
      run: pip install -r requirements.txt
      working-directory: ${{ env.APP_LOCATION }}

    - name: Prepare files for deployment
      run: |
          # Create a directory for the deployment artifact
          mkdir -p ${{ github.workspace }}/deploy-artifact
          # Copy all files and folders from APP_LOCATION to the deploy-artifact directory
          cp -R src/FlaskGraphics/* ${{ github.workspace }}/deploy-artifact/

    #- name: Upload artefact for deployment jobs
      #uses: actions/upload-artifact@v2
      #with:
        #name: python-app
        #path: ${{ github.workspace }}/deploy-artifact

    - name: Zip the application for deployment
      run: |
        cd ${{ env.APP_LOCATION }}
        zip -r app.zip .
        mv app.zip ${{ github.workspace }}

    - name: Log in to Azure CLI using service principal
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_GRAPHS }}


    - name: 'Deploy to Azure WebApp'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: ${{ github.workspace }}/app.zip
        
    #- name: 'Deploy to Azure WebApp'
     # id: deploy-to-webapp
    #  uses: azure/webapps-deploy@v2
      #with:
      #  app-name: ${{ env.AZURE_WEBAPP_NAME }}
     #   slot-name: 'Production'
     #   publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_GRAPHS }}
